version: '3.3'

services:
    kong:
        image: kong:latest
        volumes:
         - ./kong:/usr/local/kong/declarative
        environment:
            KONG_DATABASE: 'off'
            KONG_DECLARATIVE_CONFIG: /usr/local/kong/declarative/kong.yml
            KONG_PROXY_ACCESS_LOG: /dev/stdout
            KONG_ADMIN_ACCESS_LOG: /dev/stdout
            KONG_PROXY_ERROR_LOG: /dev/stderr
            KONG_ADMIN_ERROR_LOG: /dev/stderr
            KONG_ADMIN_LISTEN: 0.0.0.0:8001, 0.0.0.0:8444 ssl
        ports:
            - 80:8000
            - 443:8443
        deploy:
            placement:
                constraints: [node.role == manager]
        networks:
            - gateway-net
        depends_on:
            - auth-service
            - quizzes-service

    auth-service:
        image: claudiapreda2307/knowcc-auth:latest
        environment:
            PGUSER: admin
            PGPASSWORD: admin
            PGHOST: knowcc-cluster_db
            PGPORT: 5432
            PGDATABASE: knowcc
            NODE_ENV: development
        # deploy:
        #     replicas: 3
        #     placement:
        #         max_replicas_per_node: 2
        #     update_config:
        #         parallelism: 2
        #         delay: 10s
        #     rollback_config:
        #         order: stop-first
        #     restart_policy:
        #         condition: on-failure
        networks:
            - gateway-net
            - db-auth-net
    
    quizzes-service:
        image: claudiapreda2307/knowcc-quizzes:init
        environment:
            IO_SERVICE_HOST: knowcc-cluster_io-service
            AUTH_SERVICE_HOST: knowcc-cluster_auth-service
            NODE_ENV: development
        # deploy:
        #     replicas: 2
        #     placement:
        #         max_replicas_per_node: 1
        #     update_config:
        #         parallelism: 1
        #         delay: 10s
        #     rollback_config:
        #         order: stop-first
        #     restart_policy:
        #         condition: on-failure
        networks:
            - backend-io-net
            - gateway-net
        depends_on:
            - io-service
          
    io-service:
        image: claudiapreda2307/knowcc-io:init
        environment:
            PGUSER: admin
            PGPASSWORD: admin
            PGHOST: knowcc-cluster_db
            PGPORT: 5432
            PGDATABASE: knowcc
            NODE_ENV: development
        # deploy:
        #     replicas: 3
        #     placement:
        #         max_replicas_per_node: 2
        #     update_config:
        #         parallelism: 2
        #         delay: 10s
        #     rollback_config:
        #         order: stop-first
        #     restart_policy:
        #         condition: on-failure
        networks:
            - db-io-net
            - backend-io-net
        depends_on:
            - db

    db:
        image: postgres:12
        environment:
            POSTGRES_DB: knowcc
            POSTGRES_USER: admin
            POSTGRES_PASSWORD: admin
        volumes:
            - ./Database/init-db.sql:/docker-entrypoint-initdb.d/init.sql
            - postgres-volume:/var/lib/postgresql/data
        deploy:
            placement:
                constraints: [node.role == manager]
        networks:
            - db-adminer-net
            - db-io-net
            - db-auth-net

    adminer:
        image: adminer
        ports:
            - 8080:8080
        deploy:
            placement:
                constraints: [node.role == manager]
        depends_on:
            - db
            - gateway-service
        networks:
            - db-adminer-net
            - gateway-net
    
    frontend-service:
        image: claudiapreda2307/knowcc-frontend:init
        ports:
            - 8000:8000
        environment:
            NODE_ENV: development
            REACT_APP_GATEWAY_SERVICE_HOST: 192.168.99.100
        # deploy:
        #     replicas: 2
        #     placement:
        #         max_replicas_per_node: 1
        #     update_config:
        #         order: start-first
        #     rollback_config:
        #         order: stop-first
        #     restart_policy:
        #         condition: on-failure
        depends_on:
            - gateway-service
    
networks:
    db-adminer-net:
    db-io-net:
    db-auth-net:
    backend-io-net:
    gateway-net:
volumes:
    postgres-volume:
